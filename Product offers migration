-- ============================================
-- Latela: Product Offers Schema
-- Stores scraped product prices from SA retailers
-- ============================================

-- Product Offers Table
CREATE TABLE IF NOT EXISTS product_offers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  canonical_product_id UUID,
  store TEXT NOT NULL,
  store_product_code TEXT,
  product_name TEXT,
  brand TEXT,
  category TEXT DEFAULT 'Uncategorized',
  subcategory TEXT,
  price_cents INTEGER NOT NULL,
  unit_price_cents INTEGER,
  original_price_cents INTEGER,
  on_sale BOOLEAN DEFAULT FALSE,
  promotion_text TEXT,
  in_stock BOOLEAN DEFAULT TRUE,
  image_url TEXT,
  product_url TEXT,
  scraped_at TIMESTAMPTZ,
  last_seen_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Price History Table
CREATE TABLE IF NOT EXISTS price_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  canonical_product_id UUID,
  store TEXT,
  price_cents INTEGER NOT NULL,
  original_price_cents INTEGER,
  on_sale BOOLEAN DEFAULT FALSE,
  recorded_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_product_offers_store ON product_offers(store);
CREATE INDEX IF NOT EXISTS idx_product_offers_canonical ON product_offers(canonical_product_id);
CREATE INDEX IF NOT EXISTS idx_product_offers_on_sale ON product_offers(on_sale) WHERE on_sale = TRUE;
CREATE INDEX IF NOT EXISTS idx_price_history_canonical ON price_history(canonical_product_id);
CREATE INDEX IF NOT EXISTS idx_price_history_date ON price_history(recorded_at);

-- Update timestamp trigger
CREATE OR REPLACE FUNCTION update_product_offers_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_product_offers_updated_at ON product_offers;
CREATE TRIGGER trigger_product_offers_updated_at
  BEFORE UPDATE ON product_offers
  FOR EACH ROW
  EXECUTE FUNCTION update_product_offers_updated_at();

-- RLS Policies
ALTER TABLE product_offers ENABLE ROW LEVEL SECURITY;
ALTER TABLE price_history ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Public read product_offers" ON product_offers;
CREATE POLICY "Public read product_offers" ON product_offers FOR SELECT USING (true);

DROP POLICY IF EXISTS "Service write product_offers" ON product_offers;
CREATE POLICY "Service write product_offers" ON product_offers FOR ALL USING (auth.role() = 'service_role');

DROP POLICY IF EXISTS "Public read price_history" ON price_history;
CREATE POLICY "Public read price_history" ON price_history FOR SELECT USING (true);

DROP POLICY IF EXISTS "Service write price_history" ON price_history;
CREATE POLICY "Service write price_history" ON price_history FOR ALL USING (auth.role() = 'service_role');
